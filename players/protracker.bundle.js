!function(t){var e={};function s(r){if(e[r])return e[r].exports;var n=e[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=t,s.c=e,s.d=function(t,e,r){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(r,n,function(e){return t[e]}.bind(null,n));return r},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);const r=7093789.2;var n;!function(t){t[t.NTSC=7159090.5]="NTSC",t[t.PAL=r]="PAL"}(n||(n={}));const i={ARPEGGIO:"0",PORTAMENTO_UP:"1",PORTAMENTO_DOWN:"2",TONE_PORTAMENTO:"3",VIBRATO:"4",VOLUME_SLIDE_TONE_PORTAMENTO:"5",VOLUME_SLIDE_VIBRATO:"6",TREMOLO:"7",SET_PANNING_POSITION:"8",SET_SAMPLE_OFFSET:"9",VOLUME_SLIDE:"10",POSITION_JUMP:"11",SET_VOLUME:"12",PATTERN_BREAK:"13",SET_FILTER:"14-0",FINE_PORTAMENTO_UP:"14-1",FINE_PORTAMENTO_DOWN:"14-2",GLISSANDO:"14-3",SET_VIBRATO_WAVEFORM:"14-4",SET_FINE_TUNE:"14-5",PATTERN_LOOP:"14-6",SET_TREMOLO_WAVEFORM:"14-7",RETRIGGER_NOTE:"14-9",FINE_VOLUME_SLIDE_UP:"14-10",FINE_VOLUME_SLIDE_DOWN:"14-11",NOTE_CUT:"14-12",NOTE_DELAY:"14-13",PATTERN_DELAY:"14-14",FUNKREPEAT:"14-15",SET_SPEED:"15"},a=["sine","sawtooth","square","random"];var o;!function(t){t.STOPPED="STOPPED",t.PAUSED="PAUSED",t.PLAYING="PLAYING",t.ERROR="ERROR"}(o||(o={}));class u{constructor(t){this.status=o.STOPPED,this.audioContext=t}stop(){this.pause(),this.reset(),this.status=o.STOPPED}}var c=(t,e)=>{return{onTickStart:(s,r)=>{const n=s.getPlaybackState();n.currentTick%3==0?r.resetPeriod():n.currentTick%3==1?r.setPeriod(r.getFineTunedPeriod()/Math.pow(2,t/12)):n.currentTick%3==2&&r.setPeriod(r.getFineTunedPeriod()/Math.pow(2,e/12))}}};var l=t=>{return{onRowEnd:(e,s)=>{s.setPeriod(s.getPeriod()+t)}}};var h=t=>{return{onRowEnd:(e,s)=>{s.setPeriod(s.getPeriod()-t)}}};var p=t=>{return{onTickStart:(e,s)=>{e.getPlaybackState().currentTick>0&&s.setPeriod(s.getPeriod()+t)}}};var d=t=>{return{onTickStart:(e,s)=>{e.getPlaybackState().currentTick>0&&s.setPeriod(s.getPeriod()-t)}}};var P=(t,e)=>{return{onRowStart:(s,r)=>{const n=s.getPlaybackState(),i=r.getVibrato();i.setOriginalValue(r.getPeriod()),t&&i.setOscillationsPerRow(t*(n.speed-1)/64),e&&i.setAmplitude(2*e)},onRowEnd:(t,e)=>{const s=e.getVibrato();!1===s.getRetrigger()&&s.incrementOffset(),e.setPeriod(s.getOriginalValue())},onTickStart:(t,e)=>{const s=e.getVibrato();e.setPeriod(s.getValue(t.getRowPosition()))}}};function T(...t){return t[(e=t.length,Math.floor(Math.random()*Math.floor(e)))];var e}function g(t,e,s){return Math.max(Math.min(t,s),e)}function S(t,e){return new DataView(t).getUint8(e)}function f(t,e){return new DataView(t).getUint16(e,!1)}function m(t,e,s){return String.fromCharCode.apply(null,Array.from(new Uint8Array(t.slice(e,s))))}var E=(t,e)=>{return{onTickStart:(s,r)=>{if(s.getPlaybackState().currentTick>0){const s=r.getVolume()+t-e;r.setVolume(g(s,0,64))}}}};var R=t=>{return{onRowEnd:(e,s)=>{const r=s.getVolume()+t;s.setVolume(g(r,0,64))}}};var O=t=>{return{onRowEnd:(e,s)=>{const r=s.getVolume()-t;s.setVolume(g(r,0,64))}}};var _=(t,e)=>{return{onRowStart:(s,r)=>{const n=s.getPlaybackState(),i=r.getTremolo();i.setOriginalValue(r.getVolume()),i.setOscillationsPerRow(t*(n.speed-1)/64),i.setAmplitude(2*e)},onRowEnd:(t,e)=>{const s=e.getTremolo();!1===s.getRetrigger()&&s.incrementOffset(),e.setVolume(s.getOriginalValue())},onTickStart:(t,e)=>{const s=e.getTremolo();e.setVolume(s.getValue(t.getRowPosition()))}}};var w=t=>{return{onRowEnd:(e,s)=>{e.setPatternSequenceIndex(t,!0)}}};var k=(t,e)=>{return{onRowEnd:(s,r)=>{s.nextPattern()||s.setPatternSequenceIndex(s.getSongLoopIndex()),s.setRowIndex(10*t+e)}}};var I=t=>{return{onRowEnd:(e,s)=>{if(0===t)e.setPatternLoopRowIndex(e.getPlaybackState().currentRowIndex);else{const s=e.getPatternLoopCount()-1;e.setPatternLoopCount(s),s<0&&e.setPatternLoopCount(t),s>0&&e.setRowIndex(e.getPatternLoopRowIndex())}}}};var y=t=>{return{onTickStart:(e,s)=>{const r=e.getPlaybackState();r.currentTick<t&&s.setSampleAsEnded(),r.currentTick===t&&s.resetSample()}}};var x=t=>{return{onTickStart:(e,s)=>{e.getPlaybackState().currentTick===t&&s.setVolume(0)}}};var L=t=>{return{onTickStart:(e,s)=>{e.getPlaybackState().currentTick%t==0&&s.setSamplePosition(0)}}};var b=t=>{return{onRowStart:(e,s)=>{s.setSamplePosition(256*t)}}};var N=t=>{return{onRowStart:(e,s)=>{s.setVolume(t)}}};function v(t,e){const s=e<4,r=a[e>=4?e-4:e];t.setWaveGenerator(r),t.setRetrigger(s)}var M=t=>{return{onRowStart:(e,s)=>{const r=s.getVibrato();t<=7&&v(r,t)}}};var A=t=>{return{onRowStart:(e,s)=>{const r=s.getTremolo();t<=7&&v(r,t)}}};var V=t=>{return{onRowStart:(e,s)=>{const r=s.getInstruction();if(r&&0!==r.period){const e=t<8?t:-16+t;s.setFineTune(e)}}}};var D=t=>{return{onRowStart:(e,s)=>{t>31?e.setTempo(t):e.setSpeed(t)}}};var C=t=>{return{onRowStart:(e,s)=>{const r=s.getInstruction();t&&t>0&&s.setSlideRate(t),r&&r.period&&s.setSlideTarget(r.period)},onTickStart:(t,e)=>{e.getPeriod()>e.getSlideTarget()?e.setPeriod(Math.max(e.getPeriod()-e.getSlideRate(),e.getSlideTarget())):e.getPeriod()<e.getSlideTarget()&&e.setPeriod(Math.min(e.getPeriod()+e.getSlideRate(),e.getSlideTarget()))}}};var F=(t,e)=>{const s=E(t,e),r=P();return{onRowStart:(t,e)=>{s.onRowStart&&s.onRowStart(t,e),r.onRowStart&&r.onRowStart(t,e)},onRowEnd:(t,e)=>{s.onRowEnd&&s.onRowEnd(t,e),r.onRowEnd&&r.onRowEnd(t,e)},onTickStart:(t,e)=>{s.onTickStart&&s.onTickStart(t,e),r.onTickStart&&r.onTickStart(t,e)}}};var U=(t,e)=>{const s=E(t,e),r=C();return{onRowStart:(t,e)=>{s.onRowStart&&s.onRowStart(t,e),r.onRowStart&&r.onRowStart(t,e)},onRowEnd:(t,e)=>{s.onRowEnd&&s.onRowEnd(t,e),r.onRowEnd&&r.onRowEnd(t,e)},onTickStart:(t,e)=>{s.onTickStart&&s.onTickStart(t,e),r.onTickStart&&r.onTickStart(t,e)}}};var q=t=>{return{onRowEnd:(e,s)=>{e.setPatternDelay(t*e.state.speed)}}};function G(t){if(!t)return;switch(14===t.code?`${t.code}-${t.px}`:`${t.code}`){case i.ARPEGGIO:return c(t.px,t.py);case i.PORTAMENTO_DOWN:return p(t.p);case i.PORTAMENTO_UP:return d(t.p);case i.TONE_PORTAMENTO:return C(t.p);case i.VIBRATO:return P(t.px,t.py);case i.VOLUME_SLIDE_TONE_PORTAMENTO:return U(t.px,t.py);case i.VOLUME_SLIDE_VIBRATO:return F(t.px,t.py);case i.TREMOLO:return _(t.px,t.py);case i.SET_SAMPLE_OFFSET:return b(t.p);case i.VOLUME_SLIDE:return E(t.px,t.py);case i.POSITION_JUMP:return w(t.p);case i.SET_VOLUME:return N(t.p);case i.PATTERN_BREAK:return k(t.px,t.py);case i.FINE_PORTAMENTO_UP:return h(t.py);case i.FINE_PORTAMENTO_DOWN:return l(t.py);case i.SET_VIBRATO_WAVEFORM:return M(t.py);case i.SET_FINE_TUNE:return V(t.py);case i.PATTERN_LOOP:return I(t.py);case i.SET_TREMOLO_WAVEFORM:return A(t.py);case i.RETRIGGER_NOTE:return L(t.py);case i.FINE_VOLUME_SLIDE_UP:return R(t.py);case i.FINE_VOLUME_SLIDE_DOWN:return O(t.py);case i.NOTE_CUT:return x(t.py);case i.NOTE_DELAY:return y(t.py);case i.PATTERN_DELAY:return q(t.py);case i.SET_SPEED:return D(t.p)}}class B{constructor(){this.amplitude=1,this.offset=0,this.originalValue=0,this.oscillationsPerRow=1,this.retrigger=!1,this.waveGenerator=H}getAmplitude(){return this.amplitude}getOffset(){return this.offset}getOriginalValue(){return this.originalValue}getOscillationsPerRow(){return this.oscillationsPerRow}getRetrigger(){return this.retrigger}getValue(t){return this.originalValue+this.waveGenerator(t,this.offset,this.oscillationsPerRow,this.amplitude)}getWaveGenerator(){return this.waveGenerator}incrementOffset(){this.offset=(this.offset+this.oscillationsPerRow)%1}setAmplitude(t){t>0&&(this.amplitude=t)}setOffset(t){this.offset=t}setOriginalValue(t){this.originalValue=t}setOscillationsPerRow(t){t>0&&(this.oscillationsPerRow=t)}setRetrigger(t){this.retrigger=t}setWaveGenerator(t){switch(t){case"random":this.setWaveGenerator(T("sawtooth","sine","square"));break;case"sawtooth":this.waveGenerator=W;break;case"sine":this.waveGenerator=H;break;case"square":this.waveGenerator=j}}}const W=(t,e=0,s=1,r=1)=>{return(1-(t*s+e)%1)*r},H=(t,e=0,s=1,r=1)=>Math.sin(2*(t*s+e)*Math.PI)*r,j=(t,e=0,s=1,r=1)=>{return((t*s+e)%1<.5?1:-1)*r},$=(t,e)=>t*(e/64),Y=(t,e=0)=>0!==e?e>0?t/Math.pow(2,Math.abs(e)/96):t*Math.pow(2,Math.abs(e)/96):t,K=(t,e)=>t/(2*e),J=(t,e,s)=>{let r=e+s,n=Z(t),i=!1;return r>=n&&(t.repeatLength>2?r=t.repeatOffset+(r-n):(r=n,i=!0)),{nextPosition:r,sampleHasEnded:i}},Z=t=>t.repeatLength>2?t.repeatOffset+t.repeatLength:t.length,z=(t,e)=>t/e,Q=(t,e)=>{const s=e%1,r=t[Math.floor(e)];return r+s*(t[Math.ceil(e)]-r)},X=()=>({effect:void 0,fineTune:0,frequency:0,instruction:void 0,originalPeriod:0,fineTunedPeriod:0,period:0,sample:void 0,sampleHasEnded:!1,sampleIncrement:0,samplePosition:0,slideRate:0,slideTarget:0,tremolo:new B,vibrato:new B,volume:64});class tt{constructor(t,e){this.state=X(),this.amigaClockSpeed=e,this.bufferFrequency=t,this.reset()}fillBuffer(t,e,s){const r=Math.min(e+s,t.length);let n=e;for(;n<r;n++)null===this.state.sample||this.state.sampleHasEnded?t[n]=0:(t[n]=this._getSampleValue(),this._incrementSamplePosition())}getEffect(){return this.state.effect}getEffectCode(){return this.state.instruction?this.state.instruction.effect:void 0}getFineTune(){return this.state.fineTune}getInstruction(){return this.state.instruction}getOriginalPeriod(){return this.state.originalPeriod}getFineTunedPeriod(){return this.state.fineTunedPeriod}getPeriod(){return this.state.period}getSample(){return this.state.sample}getSamplePosition(){return this.state.samplePosition}getSlideRate(){return this.state.slideRate}getSlideTarget(){return this.state.slideTarget}getTremolo(){return this.state.tremolo}getVibrato(){return this.state.vibrato}getVolume(){return this.state.volume}reset(){this.state=X()}resetFineTune(){this.state.fineTune=this.state.sample?this.state.sample.fineTune:0}resetPeriod(){this.setPeriod(this.state.fineTunedPeriod)}resetSample(){this.state.sampleHasEnded=!1,this.state.samplePosition=0,this._calculateSampleIncrement()}resetVolume(){this.state.volume=this.state.sample?this.state.sample.volume:64}setFineTune(t){this.state.fineTune=t,this._calculateFineTunedPeriod(),this.setPeriod(this.state.fineTunedPeriod),this._calculateFrequency(),this._calculateSampleIncrement()}setInstruction(t){this.state.instruction=t,this.state.effect=G(t.effect)}setOriginalPeriod(t){this.state.originalPeriod=t,this._calculateFineTunedPeriod(),this.setPeriod(this.state.fineTunedPeriod)}setPeriod(t){this.state.period=t,this._calculateFrequency(),this._calculateSampleIncrement()}setSample(t){this.state.sample=t}setSampleAsEnded(){this.state.sampleHasEnded=!0}setSamplePosition(t){this.state.samplePosition=t}setSlideRate(t){this.state.slideRate=t}setSlideTarget(t){this.state.slideTarget=t}setVolume(t){this.state.volume=t}_calculateFrequency(){this.state.frequency=K(this.amigaClockSpeed,this.state.period)}_calculateFineTunedPeriod(){this.state.fineTunedPeriod=Y(this.state.originalPeriod,this.state.fineTune)}_calculateSampleIncrement(){this.state.sampleIncrement=z(this.state.frequency,this.bufferFrequency)}_getSampleValue(){if(this.state.sample&&!this.state.sampleHasEnded){const t=Q(this.state.sample.audio,this.state.samplePosition);return $(t,this.state.volume)}return 0}_incrementSamplePosition(){if(this.state.sample&&!this.state.sampleHasEnded){const{sample:t,samplePosition:e,sampleIncrement:s}=this.state,{nextPosition:r,sampleHasEnded:n}=J(t,e,s);this.state.samplePosition=r,this.state.sampleHasEnded=n}}}function et(t){const e=nt(t);let s=4;switch(e){case"8CHN":case"FLT8":case"CD81":case"OKTA":case"OCTA":s=8;break;case"6CHN":s=6;break;case"2CHN":s=2;break;default:/^[0-9][0-9]C[H,N]$/.test(e)?s=parseInt(e.substr(0,2)):/^TDZ[0-9]$/.test(e)?s=parseInt(e.substr(3)):/^[579]CHN$/.test(e)&&(s=parseInt(e.substr(0,1)))}return s}function st(t){return rt(t).reduce((t,e)=>Math.max(t,e))+1}function rt(t){const e=t.slice(952,1080);let s,r=0,n=[];for(s=0;s<128;s++)n[s]=S(e,s);for(s=n.length-1;s>=0;s--)if(0!==n[s]){r=s;break}return n.slice(0,r+1)}function nt(t){return m(t,1080,1084)}function it(t,e=!1){const s=new Float32Array(t.byteLength+(e?1:0)),r=new DataView(t);let n;for(n=0;n<t.byteLength;n++)s[n]=r.getInt8(n)/128;return e&&e&&(s[n]=s[n-1]),s}function at(t){return{name:m(t,0,22),length:2*f(t,22),fineTune:(e=S(t,24),e>=8?-16+e:e),volume:Math.min(S(t,25),64),repeatOffset:2*f(t,26),repeatLength:2*f(t,28)};var e}const ot={currentBufferSamplePosition:0,currentPatternSequenceIndex:0,currentRowIndex:0,currentSubtrack:0,currentTickSamplePosition:0,currentTick:0,patternDelay:-1,patternLoopCount:0,patternLoopRowIndex:0,rowsPerBeat:4,samplesPerTick:0,speed:6,tempo:125};class ut extends u{constructor(t,e){super(t),this.amigaClockSpeed=r,this.channels=[],this.state=Object.assign({},ot),this.song={channelCount:et(e),patternCount:st(e),patterns:function(t){const e=et(t),s=[],r=st(t),n=new DataView(t);let i,a,o,u,c;for(i=0;i<r;i++)for(s[i]=[],a=0;a<64;a++)for(s[i][a]=[],o=0;o<e;o++)s[i][a][o]={},u=n.getUint8(1084+64*i*e*4+a*e*4+4*o)>>4<<4,c=n.getUint8(1084+64*i*e*4+a*e*4+4*o+2)>>4,s[i][a][o].sampleIndex=u+c,u=n.getUint8(1084+64*i*e*4+a*e*4+4*o)%16<<8,c=n.getUint8(1084+64*i*e*4+a*e*4+4*o+1),s[i][a][o].period=u+c,u=n.getUint8(1084+64*i*e*4+a*e*4+4*o+2)%16,c=n.getUint8(1084+64*i*e*4+a*e*4+4*o+3),(u>0||c>0)&&(s[i][a][o].effect={code:u,extendedCode:`${u}${14===c?`-${c>>4}`:""}`,p:c,px:c>>4,py:c%16});return s}(e),patternSequence:rt(e),rowsPerPattern:function(t){switch(nt(t)){case"M!K!":return 128;default:return 64}}(e),samples:function(t,e=!1){const s=et(t),r=[];let n,i,a,o,u,c=20,l=1084+64*st(t)*s*4;for(u=0;u<31;u++)a=at(o=t.slice(c,c+30)),c+=30,n=it(i=t.slice(l,l+a.length),e),l+=a.length,r[u]=Object.assign(Object.assign({},a),{audio:n});return r}(e,!0),signature:nt(e),songLength:function(t){return S(t,950)}(e),songLoop:function(t){return S(t,951),0}(e),title:function(t){return m(t,0,20).replace(/\u0000/g," ").trim()}(e)},this._setupChannels(this.song.channelCount),this.state.samplesPerTick=this._calculateSamplesPerTick()}getChannels(){return this.channels}getPatternDelay(){return this.state.patternDelay}getPatternLoopCount(){return this.state.patternLoopCount}getPatternLoopRowIndex(){return this.state.patternLoopRowIndex}getPlaybackState(){return this.state}getPlaybackStatus(){return this.status}getRowPosition(){return(this.state.currentTick*this.state.samplesPerTick+this.state.currentTickSamplePosition)/(this.state.speed*this.state.samplesPerTick)}getSong(){return this.song}getSongLoopIndex(){return this.song.songLoop}hasSubtracks(){return!1}nextPattern(){return this.setPatternSequenceIndex(this.state.currentPatternSequenceIndex+1)}nextRow(){return this.setRowIndex(this.state.currentRowIndex+1)||this.nextPattern()}nextSubtrack(){return this.setSubtrack(this.state.currentSubtrack+1)}nextTick(){return this.setTick(this.state.currentTick+1)||this.nextRow()}pause(){return this.status===o.PLAYING&&(this.status=o.PAUSED,!0)}play(){return this.status=o.PLAYING,!0}previousPattern(){return this.setPatternSequenceIndex(this.state.currentPatternSequenceIndex-1)}previousRow(){return!!this.setRowIndex(this.state.currentRowIndex-1)||this.previousPattern()&&this.setRowIndex(this.song.rowsPerPattern-1)}previousSubtrack(){return this.setSubtrack(this.state.currentSubtrack-1)}previousTick(){return!!this.setTick(this.state.currentTick-1)||!!this.previousRow()&&(this.setTick(this.state.speed-1),!0)}reset(){this.state=Object.assign(Object.assign({},ot),{currentSubtrack:this.state.currentSubtrack}),this.channels.forEach(t=>t.reset()),this.state.samplesPerTick=this._calculateSamplesPerTick()}setAmigaClockSpeed(t){this.amigaClockSpeed=t}setPatternDelay(t){this.state.patternDelay=t}setPatternLoopCount(t){this.state.patternLoopCount=t}setPatternLoopRowIndex(t){this.state.patternLoopRowIndex=t}setPatternSequenceIndex(t,e=!1){return void 0!==t&&void 0!==this.song.patternSequence[t]&&t<=this.song.songLength-1?(this.state.currentPatternSequenceIndex=t,this.setRowIndex(0),!0):!!e&&(this.state.currentPatternSequenceIndex=0,this.setRowIndex(0),!0)}setRowIndex(t){return!!this._getCurrentPattern()[t]&&(this.state.currentRowIndex=t,this.setPatternLoopRowIndex(0),this.setTick(0),!0)}setSpeed(t){this.state.speed=t}setSubtrack(t){return!1}setTempo(t){this.state.tempo=t,this.state.samplesPerTick=this._calculateSamplesPerTick()}setTick(t){return t<this.state.speed&&t>=0&&(this.state.currentTick=t,this.state.currentTickSamplePosition=0,!0)}skipToPosition(t){return!1}onAudioProcess(t){let e=!0;return this._isDelayed()||(this._isStartofRow()&&(this._assignInstructionsToChannels(this._getCurrentRow()),this._processEffects("onRowStart")),this._isStartOfTick()&&this._processEffects("onTickStart")),this._fillBuffers(t),!this._isDelayed()&&this._isEndOfRow()&&this._processEffects("onRowEnd"),this._isEndOfTick()&&(e=this._goToNextPosition()),e?this._isBufferFull(t[0].length)?this.state.currentBufferSamplePosition=0:e=this.onAudioProcess(t):this.reset(),e}_assignInstructionsToChannels(t){this.channels.forEach((e,s)=>{const r=t[s];e.setInstruction(r),r.sampleIndex&&(e.setSample(this.song.samples[r.sampleIndex-1]),e.resetVolume()),r.period&&!function(t){if(!t)return!1;const e=14===t.code?`${t.code}-${t.px}`:`${t.code}`;return e===i.TONE_PORTAMENTO||e===i.VOLUME_SLIDE_TONE_PORTAMENTO}(r.effect)&&(e.resetFineTune(),e.setOriginalPeriod(r.period),e.resetSample())})}_calculateNumberOfSamplesToGenerate(t){return Math.min(this.state.samplesPerTick-this.state.currentTickSamplePosition,t-this.state.currentBufferSamplePosition)}_calculateSamplesPerTick(){const t=2500/this.state.tempo;return Math.round(this.audioContext.sampleRate*(t/1e3))}_fillBuffers(t){const e=this._calculateNumberOfSamplesToGenerate(t[0].length);this.channels.forEach((s,r)=>{s.fillBuffer(t[r],this.state.currentBufferSamplePosition,e)}),this.state.currentTickSamplePosition=this.state.currentTickSamplePosition+e,this.state.currentBufferSamplePosition=this.state.currentBufferSamplePosition+e}_getCurrentPattern(){return this.song.patterns[this.song.patternSequence[this.state.currentPatternSequenceIndex]]}_getCurrentRow(){return this._getCurrentPattern()[this.state.currentRowIndex]}_goToNextPosition(){let t;if(this._isDelayed()){const t=this.getPatternDelay()-1;if(this.setPatternDelay(t),-1!==t)return this.state.currentTickSamplePosition=0,!0}return(t=this.setTick(this.state.currentTick+1)||this.setRowIndex(this.state.currentRowIndex+1)||this.setPatternSequenceIndex(this.state.currentPatternSequenceIndex+1))||void 0===this.song.songLoop?t:this.setPatternSequenceIndex(this.song.songLoop)}_isBufferFull(t){return this.state.currentBufferSamplePosition===t}_isDelayed(){return this._isEndOfRow()&&this.getPatternDelay()>=0}_isEndOfRow(){return this.state.currentTick===this.state.speed-1&&this._isEndOfTick()}_isEndOfTick(){return this.state.currentTickSamplePosition===this.state.samplesPerTick}_isStartofRow(){return 0===this.state.currentTick&&0===this.state.currentTickSamplePosition}_isStartOfTick(){return 0===this.state.currentTickSamplePosition}_processEffects(t){this.channels.forEach(e=>{const s=e.getEffect();if(s)switch(t){case"onRowStart":s.onRowStart&&s.onRowStart(this,e);break;case"onRowEnd":s.onRowEnd&&s.onRowEnd(this,e);break;case"onTickStart":s.onTickStart&&s.onTickStart(this,e)}})}_setupChannels(t){this.channels.length=0;for(let e=0;e<t;e++)this.channels.push(new tt(this.audioContext.sampleRate,this.amigaClockSpeed))}}registerProcessor("protracker",class extends AudioWorkletProcessor{constructor(t={}){super(t);const e=globalThis;this.fileData=t.processorOptions.fileData,this.player=new ut(e,this.fileData),this.port.onmessage=this.onMessage.bind(this)}process(t,e,s){const r=this.player.onAudioProcess(e.map(t=>t[0]));return r||this.port.postMessage({message:"ended"}),r}onMessage(t){switch(t.data.cmd){case"play":this.player.play();break;case"pause":this.player.pause();break;case"stop":this.player.stop();break;case"getInfo":this.port.postMessage({message:"songInfo",value:this.player.getSong()})}}})}]);